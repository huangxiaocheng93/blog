# TCP/IP协议系列

[TCP/IP协议系列之网络基础](https://huangxiaocheng93.github.io/blog/post/19.html)

[TCP/IP协议系列之物理层和数据链路层](https://huangxiaocheng93.github.io/blog/post/20.html)

在TCP/IP网络模型中，虽然说划分了五层，但是对物理层和数据链路层，TCP/IP并并没有做什么规范和限制，TCP/IP以这两层的功能是透明的为前提。所以，在网络层我们才真正的开始接触到TCP/IP协议。网络层是TCP/IP协议的心脏，是最核心的所在。

# 网络层的职责

回顾一下数据链路层的职责，是让处于同一个数据链路中的主机可以互相通信。而网络层的职责范围就更大了，让世界上任何两台已连网的主机之间都能实现互相通信。

为了实现这个目标，我们需要解决如下的几个问题：

1. 寻址，给世界上所有的主机分配唯一的地址，用来定位主机的位置；
2. 路由，我们需要能通过地址找到从发送端到接收端的最佳路径；
3. 数据包转发，找到路径以后，我们需要正确的把数据包通过中转站发送到接收端；

> [!TIP]
> 在网络层有几个概念需要统一，所有接入网络的设备，我们都称为**节点**；配置有IP地址同时具有路由、转发等功能的设备，我们叫做**路由器**或者**三层交换机**；配置有IP地址但是不具备路由、转发功能的设备，我们叫做主机。

# IP协议

IP协议是TCP/IP在网络层的核心协议，IP协议就是为了解决寻址、路由和数据包转发等问题。

## 寻址

在数据链路层的时候我们已经接触过了寻址的概念（(看这里)[https://blog.npex.top/post/20.html#mac地址），数据链路层使用MAC地址作为主机唯一地址，那在网络层是否也可以使用MAC地址呢？

答案是不行的，虽然MAC地址是唯一的，能够唯一标识一台主机，看上去是可行的，但是在网络层使用MAC地址标识主机会遇到很大的麻烦。

在数据链路层，接入网络的主机数量是有限的，所以交换机维护一个地址映射表是完全可行的。但是在网络层，接入的主机数据已经不是一个数量级了，所以维护一个MAC地址的映射表就不可能了。

所以在网络层，IP协议设计了新的地址，就是**IP地址**。接下来就看看IP地址是怎么设计的。

### IP地址的格式

IP地址的格式如下：

![image](https://github.com/user-attachments/assets/fe01dbf6-4159-4259-9d75-833a8cbcf7a1)

IP地址使用4字节共32位表示，平时我们看到的IP地址都是使用十进制点符号表示的，例如：`192.168.10.12` 。

IP地址由**网络地址**和**主机地址**两部分组成：**网络地址用来唯一定位一个网络，主机地址用来唯一定位该网络能的唯一主机**。

网络地址和主机地址是一个此消彼长的关系，网络地址的位数越多，我们能划分的网络个数就越多，但是单个网络中能容纳的主机数量就越少（因为网络地址占的位数多，主机地址的位数自然就少了）；网络地址的位数越少，单个网络能容纳的主机数就越多，但是能划分的网络个数就越少。

接下来看一下IP地址分配的问题，首先看看我们的需求：
- 一个局域网我们称之为一个网络，网络内的主机都应该分配到IP地址；
- IP地址的网络位部分，我们叫做网段地址，网络位相同的IP地址就位于同一个网段，同一个网段的主机应该在同一个局域网中，方便我们对主机寻址；
- 网段能容纳的主机数量尽量匹配局域网内的主机数量，避免IP地址的浪费；

### 第一种分配方法

为了满足上面的需求，我们将网段根据能容纳主机的多少分成几个级别，然后给不同规模的网络分配不同级别的网段，这样就可以保证网络内的每台主机都有IP地址，同时他们也在同一个网段内，并且能尽量减少IP地址的浪费。

根据上述思路，我们将IP网段划分为了ABCDE五类。

#### A类

![image](https://github.com/user-attachments/assets/d79219e3-792d-40ab-8096-b29fe746417a)

A类地址是0开头，网络位占8位，主机位占24位，网段从0.0.0.0到127.0.0.0，一个网段最多可以容纳16777214台主机。

#### B类

![image](https://github.com/user-attachments/assets/f91ff0c7-bcbb-4039-8c4f-975ee62e1450)

B类地址是10开头，网络位占16位，主机位占16位，网段从128.0.0.0到191.255.0.0，一个网段最多可以容纳65534台主机。

#### C类

![image](https://github.com/user-attachments/assets/c5dad08a-12e4-44a8-b5cd-6b2b689cd12c)

C类地址是110开头，网络位占24位，主机位占8位，网段从192.0.0.0到223.255.255.0，一个网段最多可以容纳254台主机。

#### D类

![image](https://github.com/user-attachments/assets/836d04d0-ac05-4e6e-b688-2cdc2eac160f)

C类地址是1110开头，网络位占32位，没有主机位，网段从224.0.0.0到239. 255. 255. 255，D类地址没有主机位，所以是特殊用途，一般用来做多播之类的功能。

#### E类

E类地址实际上是未划分的地址，是1111开头，保留使用。

### 总结

如上，我们把IP网段划分为了5种类型，我们就可以根据不同网络规模的需求，分配匹配的网段了，我们暂且把这种分配方法叫做**分级法**。

### 第二种分配方法

分级法有什么问题吗？肯定有，要不然就不会再出另外的方案了，问题如下：

1. 低估了网络发展的速度，网段不够用了；
2. 分级太过粗糙，ABC类地址容纳的主机数量跳跃幅度太大，所以一个网段分配出去，往往浪费的地址还是非常多；

总结一下，分级法的问题是分级太过粗糙了，为了解决这个问题，我们就必须摒弃掉这种固定的分级方式，转而使用灵活的网段划分方法。

假如现在有一个局域网内有255台设备，使用分级法就必须给这个网络分配一个B类网段，结果就是这个网段内的大部分地址都被浪费了。
如果我们可以把两个C类网段合并一下，然后分配给这个局域网，浪费就会大大减少了。合并的方法就是把C类地址的网络地址**借**一位给主机地址，这样这个网络能容纳的主机数就翻倍了。

这种分配方法叫做**CIDR**（无类别域间路由）。
在分级法中，不同的IP地址天然的就携带了网络位的信息，但是使用CIDR方法就发生了变化，网络位的长度不再是固定的了，所以引入了新的网络位表示方法。
例如地址：`192.168.10.12`，如果是分级法，这个地址默认就是C类地址，网络位占24位。但是在CIDR中需要这样表示：`192.168.10.12/24`，`24`表示网络位占24位。

**CIDR**进一步提升了IP地址的利用率，浪费的就更少了；同时可以根据网络规模任意的指定网络位长度，也相当于增加了网段的个数。

### 子网掩码

IP地址的网络位还有一种表示方法，就是**子网掩码**，如下图：

![image](https://github.com/user-attachments/assets/6b9e0eab-ae5f-4105-ac42-2c3506dc91b3)

// todo

### IPv4和IPv6

#### IPv4
使用32位表示的这种IP地址叫做**IPv4**，IPv4理论上最大能有2的32次方个IP地址可用，大概是43亿个左右。排除掉特殊作用的地址、分配给内网地址、未定义的地址的等等，剩下可用的总共大约40亿个左右。
实际上，IPv4地址基本已经全部分配完了，而且绝大部分的设备都没有自己的IPv4地址，都是采用NAT等方法多台主机共用同一个IPv4地址。
所以网络的发展速度是远超当初协议的设计者的想象。

#### IPv6
当IPv4已经无法顺应时代需求的时候，IPv6就应运而生了，IPv6采用128位来表示，所以理论上IPv6能容纳的主机数为2的128次方。但是IPv6替换IPv4仍然任重道远。

## 路由

在网络世界里，两台主机的通信，实际上就是数据包从发送端主机一路传输到接收端主机的过程。这个过程很想是现实世界中的快递包裹运送的过程，发件方就是发送端，收件方就是接收端，数据包的投递过程就是快递公司将包裹送达的过程。

// todo




